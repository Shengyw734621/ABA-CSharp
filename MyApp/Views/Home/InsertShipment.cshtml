@{
    ViewData["Title"] = "æ–°å¢å‡ºè²¨ç´€éŒ„";
}

<style>
    .navbar{
        position: sticky;
        top: 0;
        z-index: 200;
        background-color: white; /* é ˆæŒ‡å®šèƒŒæ™¯ï¼Œå¦å‰‡æœƒé€ */
    }
    #content {
        width: 100%;
        height: auto;            
        padding: 100px 200px;   /* å…§ç¸®ï¼Œè®“å…§å®¹é›¢é‚Šç•Œä¸æœƒå¤ªç·Š */
        font-family: "PMingLiU", "æ–°ç´°æ˜é«”", serif;       
        box-sizing: border-box; 
        background-color: #fff; 
        /* border: 1px solid #000;   */
        font-size: 18px;       
    }
    .pdf-container{
        margin-top: 60px;
        margin-bottom: 60px;
    }
    .header {
        position: relative; /* logo æœƒä»¥é€™å€‹ç‚ºå®šä½åŸºæº– */
        text-align: center;
        margin-bottom: 20px;
    }

    .logo {
        margin-left: 700px;
        width: 180px;
        height: auto;
    }

    .header-container {
        margin-top: 60px; /* å¾€ä¸‹æ¨ï¼Œé¿å…æ–‡å­—è·Ÿ logo é‡ç–Š */
    }

    .company-name {
        font-family: "PMingLiU", "æ–°ç´°æ˜é«”", serif;
        font-size: 32px;
        margin: 0; /* é¿å…é¡å¤–é–“è· */
    }
    
    .shipment-title {
        text-align: center;
        font-family: "PMingLiU", "æ–°ç´°æ˜é«”", serif;
        font-size: 42px;
        font-weight: normal;
    }

    .shipment-title .main {
        letter-spacing: 1.3em;   /* åˆ†æ•£ä¸‰å€‹å­— */
        margin-right: -1.8em;    /* æŠŠæœ€å¾Œä¸€å€‹å­—çš„ç©ºç™½è£œå›ä¾† */
    }

    .shipment-title .sub {
        font-size: 20px;
        font-weight: normal;
        margin-left: 10px;
    }

    .shipment-title .sub .paren {
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        font-weight: 800;
    }

    .shipment-title .sub .text {
        font-family: "PMingLiU", "æ–°ç´°æ˜é«”", serif;
        margin-left: -0.2em;
        margin-right: -0.2em;
    }
    #year, #month, #day{
        appearance: none;
        border: none;
    }
    .customer-info {
        margin-bottom: 20px;
        margin-left: 20px;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 5px 20px;
    }
    .table-container{
        border: 5px solid #000;
    }
    .customer-info p{
        display: grid;
        grid-template-columns: 100px 1fr; /* ç¬¬ä¸€æ¬„å›ºå®šå¯¬åº¦ï¼Œç¬¬äºŒæ¬„å¡«æ»¿ */
        align-items: center;
        margin: 5px 0;
    }
    .date-select {
        display: flex;
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        align-items: center; /* å‚ç›´ç½®ä¸­ */
    }
    .customer-info .ContactPerson{
        letter-spacing: -0.5em;   /* åˆ†æ•£ä¸‰å€‹å­— */
    }
    .customer-info .ShipmentNo{
        margin-left: 110px;
    }
    .customer-info input {
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        border: none;
        width: 100%;
        text-align: left;
    }
    .shipment-table{
        width: 99.8%;
        border-collapse: collapse;
        margin: 1px;
    }
    .shipment-table thead{
        background-color: #C1DFEB;
    }
    .shipment-table th, .shipment-table td {
        border:1px solid #000; 
        padding:5px;
        text-align: center;
    }
    .shipment-table .no-cell { 
        width:60px; text-align:center; 
    }
    .shipment-table input {
        width: 100%;
        border: none;
    }
    tr.major { 
        background:#fff; 
    }
    tr.minor { 
        background:#fafafa; 
    }
    tr.major:hover { 
        background:#f0f8ff; cursor:pointer; 
    }
    tr.active { 
        background:#dceeff; border-left:1px solid #2a7bd4; 
    }
    tr.note-row {
        background: #fff !important;
        cursor: default !important;
    }

    tr.note-row:hover {
        background: #fff !important;
    }
    .note{
        text-align: left;
    }
    tr.sign-row{
        background: #fff !important;
        cursor: default !important;
    }
    tr.sign-row:hover {
        background: #fff !important;
    }
    tr.sign-row td {
        height: 75px;
        vertical-align: middle;
    }
    tr.sign-row td.person {
        width: 0.6%;
        white-space: nowrap; /* é¿å…è‡ªå‹•æ›è¡Œ */
    }
    tr.sign-row td.sign{
        width: 15%;
    }
    tr.sign-row input {
        border: none;
        width: 100%;/* è¼¸å…¥æ¡†å æ¯”å¯è‡ªè¡Œèª¿æ•´ */
    }
    #handlerSelect,
    #salesSelect{
        border: none;
        width: 100%;/* è¼¸å…¥æ¡†å æ¯”å¯è‡ªè¡Œèª¿æ•´ */
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        text-align: center;
        appearance: none;

    }
    .signature-table{
        width: 99.8%;
        border-collapse: collapse;
        margin: -1px 1px 1px 1px;
    }
    .signature-table tr{
        border-top: none;
        border-right:1px solid #000;
        border-bottom:1px solid #000;
        border-left:1px solid #000;
        text-align: center;
    }
    .signature-table td {
        border-top: none;
        border-right:1px solid #000;
        border-bottom:1px solid #000;
        border-left:1px solid #000;
        padding: 6px;
        text-align: center;
    }

    .actions {
        text-align: center;
        margin-top: 20px;
    }
    input{
        text-align: center;
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
    }
    input[type="checkbox"] {
        appearance: none;         /* æ¨™æº–å±¬æ€§ */
        width: 20px;
        height: 20px;
        border: 1px solid #333;
        transform: scale(0.8);
        border-radius: 0;        /* å®Œå…¨æ–¹å½¢ */
    }
    .product-type-select{
        text-align: center;
        appearance: none; 
        border: none;
    }
    .major-ProductName,
    .minor-ProductName{
        appearance: none;
        resize: none;
        width: 360px;
        height: 50px;
        border: none;
        text-align: center;
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
    }
    .ShipmentNoInput
    {
        text-align: left;
    }
    button {
        margin: 5px;
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        background: #007bff;
        color: #fff;
        cursor: pointer;
    }
    button:hover {
        background: #0056b3;
    }
</style>

<div id="content">
    <div class="pdf-container">
        <!-- å…¬å¸æŠ¬é ­ -->
        <div class="header">
            <img src="/images/logo.png" alt="å…¬å¸ Logo" class="logo">
            <div class="header-container">
                <h2 class="company-name">å¨æ£®åœ‹éš›è‚¡ä»½æœ‰é™å…¬å¸</h2>
            </div>
            <h1 class="shipment-title">
                <span class="main">å‡ºè²¨å–®</span>
                <span class="sub">
                    <span class="paren">(</span>
                    <span class="text">ä¸€å¼äºŒä»½</span>
                    <span class="paren">)</span>
                </span>
            </h1>
        </div>

        <!-- å®¢æˆ¶è³‡è¨Š -->
        <div class="customer-info">
            <p></p>
            <p class="ShipmentNo">å‡ºè²¨å–®è™Ÿï¼š<input type="text" name="ShipmentNo" class="ShipmentNoInput" value="CB-001-"/></p>
            <p class="CustomerName">å®¢ã€€ã€€æˆ¶ï¼š<input type="text" name="CustomerName" /></p>
            <p>
            å‡ºè²¨æ—¥æœŸï¼š
                <span class="date-select">
                    <select id="year"></select>.
                    <select id="month"></select>.
                    <select id="day"></select>
                </span>
            </p>
            <p class="ContactPerson">è¯ã€€ã€€çµ¡ã€€ã€€äººã€€ï¼š<input type="text" name="ContactPerson" /></p>
            <p>é›»ã€€ã€€è©±ï¼š<input type="text" name="Phone" /></p>
            <p>å‡ºè²¨åœ°å€ï¼š<input type="text" name="Address"/></p> 
            <p>å‚³ã€€ã€€çœŸï¼š<input type="text" name="Fax" /></p>
        </div>

        <div class="table-container">
            <!-- è¡¨æ ¼ -->
            <table class="shipment-table">
                <thead>
                <tr>
                    <th>NO.</th>
                    <th>é¡åˆ¥</th>
                    <th>ç”¢å“åç¨±</th>
                    <th>å‹è™Ÿ/åºè™Ÿ</th>
                    <th>æ•¸é‡</th>
                </tr>
                </thead>
                <tbody id="shipmentItems">
                    <!-- ç¯„ä¾‹ç¬¬ä¸€åˆ—ç‚ºå¤§é … -->
                    <tr class="major">
                        <td class="no-cell">1</td>
                        <td>
                            <select name="ProductType" class="product-type-select"></select>
                        </td>
                        <td>
                            <select name="ProductName" class="major-ProductName">
                                <option value="">è«‹å…ˆé¸æ“‡ç”¢å“é¡åˆ¥</option>
                            </select>
                        </td>
                        <td><input type="text" name="ProductSN" /></td>
                        <td><input type="text" name="Quantity" /></td>
                    </tr>

                    <!-- å‚™è¨»åˆ— -->
                    <tr class="note-row">
                        <td>å‚™ è¨»</td>
                        <td colspan="4"><input type="text" name="Note" class="note" /></td>
                    </tr>
                </tbody>
            </table>
            <table class="signature-table">
                <!-- ç°½ååˆ— -->
                <tr class="sign-row">
                    <td class="person">
                        æ¥­ å‹™
                    </td>
                    <td class="sign">
                        <select id="salesSelect" name="SalesSign">
                            <option value="">è¼‰å…¥ä¸­...</option>
                        </select>
                    </td>
                    <td class="person">
                        ç¶“ è¾¦
                    </td>
                    <td class="sign">
                        <select id="handlerSelect">
                            <option value="">è¼‰å…¥ä¸­...</option>
                        </select>
                    </td>
                    <td class="person">
                        å®¢ æˆ¶
                    </td>
                    <td class="sign">
                        <input type="text" name="CustomerSign" />
                    </td>
                </tr>
            </table>
        </div>
    </div>
    
    

    <!-- æŒ‰éˆ• -->
    <button type="button" id="addMajorBtn">
        <i class="fa-solid fa-plus"></i>
        æ–°å¢å¤§é …
    </button>
    <button type="button" id="addMinorBtn">
        <i class="fa-solid fa-plus"></i>
        æ–°å¢ç´°é …
    </button>
    <button type="button" id="deleteRowBtn">
        <i class="fa-solid fa-trash"></i>
        åˆªé™¤é …ç›®
    </button>

    <!-- é€å‡ºæŒ‰éˆ• -->
    <div class="actions">
        <button type="submit">å„²å­˜</button>
        <button type="button" onclick="history.back()">è¿”å›</button>
    </div>
</div>

@section Scripts{
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
        // è¼‰å…¥å¹´ä»½ & æœˆä»½
        const yearSelect = document.getElementById("year");
        const monthSelect = document.getElementById("month");
        const daySelect = document.getElementById("day");

        const today = new Date();
        const thisYear = today.getFullYear();
        const thisMonth = today.getMonth() + 1; // getMonth() 0-11
        const thisDay = today.getDate();

        for (let y = 2015; y <= thisYear; y++) {
            let opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            if (y === thisYear) opt.selected = true; // é è¨­ä»Šå¹´
            yearSelect.appendChild(opt);
        }

        for (let m = 1; m <= 12; m++) {
            let opt = document.createElement("option");
            opt.value = m;
            opt.textContent = String(m).padStart(2, "0");
            if (m === thisMonth) opt.selected = true; // é è¨­ç•¶æœˆ
            monthSelect.appendChild(opt);
        }

        // æ ¹æ“šå¹´ä»½ & æœˆä»½ç”¢ç”Ÿæ—¥
        function updateDays() {
            daySelect.innerHTML = ""; // å…ˆæ¸…ç©º
            let year = parseInt(yearSelect.value);
            let month = parseInt(monthSelect.value);
            let daysInMonth = new Date(year, month, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
            let opt = document.createElement("option");
            opt.value = d;
            opt.textContent = String(d).padStart(2, "0");
            if (d === thisDay && year === thisYear && month === thisMonth) {
                opt.selected = true; // é è¨­ä»Šå¤©
            }
            daySelect.appendChild(opt);
            }
        }

        yearSelect.addEventListener("change", updateDays);
        monthSelect.addEventListener("change", updateDays);

        // åˆå§‹åŒ–å‘¼å«ï¼Œè®“ç¬¬ä¸€æ¬¡è¼‰å…¥å°±æœ‰æ—¥æœŸ
        updateDays();
    </script>


    <script>
        //ç°½åæ¬„è¼‰å…¥è¡Œæ”¿éƒ¨å“¡å·¥è³‡æ–™
        $(document).ready(function () {
            $.ajax({
                url: '/Home/GetShipmentHandlers', // æ‰“åˆ°å¾Œç«¯çš„ action
                type: 'GET',
                success: function (data) {
                    let $select = $('#handlerSelect');
                    $select.empty(); // æ¸…ç©ºèˆŠè³‡æ–™
                    if (data.length > 0) {
                        $.each(data, function (i, name) {
                            $select.append($('<option>', {
                                value: name,
                                text: name
                            }));
                        });
                    } else {
                        $select.append($('<option>', {
                            value: '',
                            text: 'ç„¡å¯é¸æ“‡äººå“¡'
                        }));
                    }
                },
                error: function () {
                    alert("è¼‰å…¥å“¡å·¥å¤±æ•—ï¼");
                }
            });
        });
    </script>
    
    <script>
        //ç°½åæ¬„è¼‰å…¥è¡Œæ”¿éƒ¨å“¡å·¥è³‡æ–™
        document.addEventListener("DOMContentLoaded", function () {
            fetch('/Home/GetSalesHandlers')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById("salesSelect");
                    select.innerHTML = "";
                    if (data.length > 0) {
                        data.forEach(name => {
                            const opt = document.createElement("option");
                            opt.value = name;
                            opt.textContent = name; // åå­— + å§“æ°
                            select.appendChild(opt);
                        });
                    } else {
                        const opt = document.createElement("option");
                        opt.value = "";
                        opt.textContent = "ç„¡å¯é¸æ“‡äººå“¡";
                        select.appendChild(opt);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("è¼‰å…¥å“¡å·¥å¤±æ•—ï¼");
                });
        });
    </script>
    <script>
        //å‡ºè²¨å–®ç”¢å“é¡åˆ¥è¼‰å…¥
        // AJAX å–å¾— product type
        function loadProductTypes($select) {
            $.ajax({
                url: '/Home/GetProductTypes',
                type: 'GET',
                success: function (data) {
                    $select.empty().append('<option value="">--è«‹é¸æ“‡--</option>');
                    data.forEach(function (type) {
                        $select.append('<option value="' + type + '">' + type + '</option>');
                    });
                },
                error: function (err) {
                    console.error("è¼‰å…¥ product_type å¤±æ•—", err);
                    $select.html('<option value="">è¼‰å…¥å¤±æ•—</option>');
                }
            });
        }


        // äº‹ä»¶å§”æ´¾ï¼šå‹•æ…‹ç›£è½æ‰€æœ‰ ProductType select
        $(document).on("change", ".product-type-select", function () {
            const selectedType = $(this).val();
            const $row = $(this).closest("tr");
            const $productNameSelect = $row.find(".major-ProductName");

            $productNameSelect.html('<option value="">è¼‰å…¥ä¸­...</option>');

            if (selectedType) {
                $.getJSON('/Home/GetProductNames', { type: selectedType })
                .done(function(names) {
                    $productNameSelect.html('<option value="">è«‹é¸æ“‡ç”¢å“</option>');
                    names.forEach(function(name) {
                        $productNameSelect.append('<option value="' + name + '">' + name + '</option>');
                    });
                })
                .fail(function() {
                    $productNameSelect.html('<option value="">è¼‰å…¥å¤±æ•—</option>');
                });
            } else {
                $productNameSelect.html('<option value="">è«‹å…ˆé¸æ“‡ç”¢å“é¡åˆ¥</option>');
            }
        });

        // åªè¦ document ready å°±è¼‰å…¥ç¾æœ‰ row çš„ ProductType
        $(document).ready(function () {
            loadAllProductTypeSelects();
        });

        // çµ±ä¸€å‡½æ•¸ï¼šè¼‰å…¥ tbody å…§æ‰€æœ‰ ProductType select
        function loadAllProductTypeSelects() {
            $('#shipmentItems .product-type-select').each(function () {
                loadProductTypes($(this));
            });
        }
    </script>

    <script>
        //å‡ºè²¨å–®é …ç›®æ¬„ä½æ“ä½œ
        (function () {
            const tbody = document.getElementById('shipmentItems');
            const addMajorBtn = document.getElementById('addMajorBtn');
            const addMinorBtn = document.getElementById('addMinorBtn');
            const noteRow = document.querySelector(".note-row"); // å‚™è¨»åˆ—
            const signRow = document.querySelector(".sign-row"); //ç°½ååˆ—

            // å»ºç«‹å¤§é …åˆ— DOM
            function createMajorRow() {
                const tr = document.createElement('tr');
                tr.className = 'major';
                tr.innerHTML = `
                    <td class="no-cell"></td>
                    <td>
                        <select name="ProductType" class="product-type-select"></select>
                    </td>
                    <td>
                        <select name="ProductName" class="major-ProductName">
                            <option value="">è«‹å…ˆé¸æ“‡ç”¢å“é¡åˆ¥</option>
                        </select>
                    </td>
                    <td><input type="text" name="ProductSN" /></td>
                    <td><input type="text" name="Quantity" /></td>
                `;
                bindRowClick(tr);

                // æ–°å¢ row ä¹Ÿè¦è¼‰å…¥ ProductType
                loadProductTypes($(tr).find('.product-type-select'));

                // ğŸ”‘ å¾ major row å–å¾—ä½¿ç”¨è€…é¸çš„ ProductName
                const productName = majorRow.querySelector('.major-ProductName').value;
                if (productName) {
                    $.getJSON('/Home/GetAccessories', { productName: productName })
                    .done(function(accessories) {
                        if (accessories.length > 0) {
                            let select = $('<select name="ProductName" class="minor-ProductName"></select>');
                            select.append('<option value="">--è«‹é¸æ“‡é…ä»¶--</option>');
                            accessories.forEach(acc => {
                                select.append('<option value="' + acc + '">' + acc + '</option>');
                            });
                            $(tr).find('.minor-product-cell').html(select);
                        }
                    })
                    .fail(function() {
                        console.error("è¼‰å…¥ accessories å¤±æ•—");
                    });
                }

                return tr;
            }

            // å»ºç«‹ç´°é …åˆ— DOM
            function createMinorRow(majorProductName) {
                const tr = document.createElement('tr');
                tr.className = 'minor';
                tr.innerHTML = `
                    <td class="no-cell"></td>
                    <td></td>
                    <td>
                        <select name="ProductName" class="minor-ProductName">
                            <option value="">è«‹å…ˆé¸æ“‡ç”¢å“åç¨±</option>
                        </select>
                    </td>
                    <td><input type="text" name="ProductSN" /></td>
                    <td style="text-align:center;"><input type="checkbox" name="QuantityCheckbox" /></td>
                `;
                bindRowClick(tr);

                // ç«‹åˆ»è¼‰å…¥ï¼ˆè‹¥ major å·²é¸ï¼‰
                const $tr = $(tr);
                const $minorSelect = $tr.find('.minor-ProductName');
                if (majorProductName) {
                    loadAccessories(majorProductName, $minorSelect);
                } else {
                    // è‹¥ major å°šæœªé¸ï¼Œé¡¯ç¤ºæç¤ºï¼›ç•¶ major ä¹‹å¾Œé¸å¥½æ™‚ï¼Œå‰é¢çš„ change handler æœƒæ›´æ–°å®ƒå€‘
                    $minorSelect.html('<option value="">è«‹å…ˆé¸æ“‡ç”¢å“åç¨±</option>');
                }
@* 
                if (majorProductName) {
                    $.ajax({
                        url: `/Home/GetAccessories`,  // ä½ å¾Œç«¯çš„ API
                        type: 'GET',
                        data: { productName: majorProductName },
                        success: function (accessories) {
                            const select = $(tr).find('.minor-ProductName');
                            select.empty(); // æ¸…ç©ºåŸæœ¬çš„ option
                            if (accessories && accessories.length > 0) {
                                select.append(`<option value="">è«‹é¸æ“‡é…ä»¶</option>`);
                                accessories.forEach(acc => {
                                    select.append(`<option value="${acc}">${acc}</option>`);
                                });
                            } else {
                                select.append(`<option value="">ç„¡å¯ç”¨é…ä»¶</option>`);
                            }
                        },
                        error: function () {
                            const select = $(tr).find('.minor-ProductName');
                            select.empty().append(`<option value="">è¼‰å…¥å¤±æ•—</option>`);
                        }
                    });
                } *@

                return tr;
            }

            // ç¶å®šé»æ“Šè¡Œ â†’ è¨­å®š active
            function bindRowClick(tr) {
                if (tr.classList.contains("note-row") || tr.classList.contains("sign-row")) return; // è·³éå‚™è¨»åˆ—
                tr.addEventListener('click', function (e) {
                    if (e.target.tagName.toLowerCase() === 'input') return;
                    setActiveRow(tr);
                });
            }

            // è¨­å®šæŸå€‹ row ç‚º activeï¼ˆåƒ…ä¸€å€‹ï¼‰
            function setActiveRow(tr) {
                const allRows = tbody.querySelectorAll('tr');
                allRows.forEach(r => r.classList.remove('active'));
                tr.classList.add('active');
            }

            // ---------- å…±ç”¨ï¼šè¼‰å…¥é…ä»¶çš„å‡½å¼ ----------
            function loadAccessories(productName, $select) {
                if (!productName) {
                    $select.html('<option value="">è«‹å…ˆé¸æ“‡ç”¢å“åç¨±</option>');
                    return;
                }

                $select.html('<option value="">è¼‰å…¥ä¸­...</option>');

                $.ajax({
                    url: '/Home/GetAccessories', // è«‹ç¢ºèª Controller route æ˜¯ /Home/GetAccessories
                    type: 'GET',
                    data: { productName: productName },
                    success: function (data) {
                        $select.empty();
                        if (data && data.length > 0) {
                            $select.append('<option value="">è«‹é¸æ“‡é…ä»¶</option>');
                            data.forEach(function (acc) {
                                $select.append('<option value="' + acc + '">' + acc + '</option>');
                            });
                        } else {
                            $select.append('<option value="">(ç„¡å¯ç”¨é…ä»¶)</option>');
                        }
                    },
                    error: function () {
                        $select.html('<option value="">è¼‰å…¥å¤±æ•—</option>');
                    }
                });
            }

            // ---------- ç•¶ major çš„ productName æ”¹è®Šæ™‚ï¼Œæ›´æ–°å®ƒåº•ä¸‹æ‰€æœ‰ minor çš„é…ä»¶ select ----------
            $(document).on('change', '.major-ProductName', function () {
                const productName = $(this).val();
                const $majorRow = $(this).closest('tr');

                // å¾€ä¸‹æ‰¾æ‰€æœ‰å±¬æ–¼é€™å€‹ major çš„ minorï¼ˆç›´åˆ°é‡åˆ°ä¸‹ä¸€å€‹ major / note-row / sign-rowï¼‰
                let $next = $majorRow.next();
                while ($next.length && $next.hasClass('minor')) {
                    const $minorSelect = $next.find('.minor-ProductName');
                    if ($minorSelect.length) {
                        loadAccessories(productName, $minorSelect);
                    }
                    $next = $next.next();
                }
            });

            // æ–°å¢å¤§é …
            addMajorBtn.addEventListener('click', function () {
                const activeRow = tbody.querySelector('tr.active');
                const newMajor = createMajorRow();

                if (activeRow && !activeRow.classList.contains("note-row") && !activeRow.classList.contains("sign-row")) {
                    // æ‰¾åˆ°æ’å…¥é»ï¼ˆå¦‚æœ active æ˜¯å¤§é …ï¼Œæ’åœ¨å®ƒçš„å€å¡Šå¾Œé¢ï¼‰
                    let insertAfter = activeRow;
                    if (activeRow.classList.contains('major')) {
                        let next = insertAfter.nextElementSibling;
                        while (next && next.classList.contains('minor')) {
                            insertAfter = next;
                            next = insertAfter.nextElementSibling;
                        }
                    }
                    insertAfter.after(newMajor);
                } else {
                    // é è¨­æ’åœ¨å‚™è¨»åˆ—ä¹‹å‰
                    tbody.insertBefore(newMajor, noteRow, signRow);
                }

                refreshMajorNumbers();
                setActiveRow(newMajor);
            });

            // æ–°å¢ç´°é …
            addMinorBtn.addEventListener('click', function () {
                const activeRow = tbody.querySelector('tr.active');
                if (!activeRow || !activeRow.classList.contains('major')) {
                    alert('è«‹å…ˆé»é¸è¦åŠ å…¥ç´°é …çš„å¤§é …');
                    return;
                }
                let insertAfter = activeRow;
                let next = insertAfter.nextElementSibling;
                while (next && next.classList.contains('minor')) {
                    insertAfter = next;
                    next = insertAfter.nextElementSibling;
                }

                // å–å¾—è©² major ç›®å‰é¸çš„ productNameï¼ˆè‹¥å­˜åœ¨ï¼‰
                const majorProductName = $(activeRow).find('.major-ProductName').val() || null;
                const newMinor = createMinorRow(majorProductName);
                insertAfter.after(newMinor);
            });

            // åˆªé™¤é …ç›®
            document.getElementById("deleteRowBtn").addEventListener("click", function () {
                const activeRow = document.querySelector("#shipmentItems tr.active");
                if (!activeRow || activeRow.classList.contains("note-row") || activeRow.classList.contains("sign-row")) {
                    alert("è«‹å…ˆé»é¸è¦åˆªé™¤çš„å¤§é …æˆ–ç´°é …");
                    return;
                }

                if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä¸€åˆ—å—ï¼Ÿ")) return;

                if (activeRow.classList.contains("major")) {
                    // åˆªå¤§é … â†’ é€£åŒç´°é …ä¸€èµ·åˆª
                    let nextRow = activeRow.nextElementSibling;
                    while (nextRow && nextRow.classList.contains("minor")) {
                        const temp = nextRow.nextElementSibling;
                        nextRow.remove();
                        nextRow = temp;
                    }
                    activeRow.remove();
                } else {
                    // åˆªç´°é … â†’ å–®ç¨åˆªæ‰
                    activeRow.remove();
                }

                refreshMajorNumbers();
            });

            // åˆå§‹åŒ– â†’ ç¶å®šç¾æœ‰ row
            document.querySelectorAll('#shipmentItems tr').forEach(bindRowClick);

            refreshMajorNumbers();
        })();

        // æ›´æ–°å¤§é …ç·¨è™Ÿ
        function refreshMajorNumbers() {
            const rows = document.querySelectorAll("#shipmentItems tr");
            let majorCount = 1;
            rows.forEach(row => {
                if (row.classList.contains("major")) {
                    row.cells[0].textContent = majorCount++;
                } else if (row.classList.contains("minor")) {
                    row.cells[0].textContent = "";
                }
            });
        }
    </script>
    
}